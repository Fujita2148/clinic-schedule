# クリニック スケジュール管理システム — 操作説明書

## 目次

1. [システム概要](#1-システム概要)
2. [環境構築・セットアップ](#2-環境構築セットアップ)
3. [画面構成と基本操作](#3-画面構成と基本操作)
4. [シフト表（メイン画面）](#4-シフト表メイン画面)
5. [職員管理](#5-職員管理)
6. [業務コード管理](#6-業務コード管理)
7. [イベント管理](#7-イベント管理)
8. [ルール管理](#8-ルール管理)
9. [自動案生成（ソルバー）](#9-自動案生成ソルバー)
10. [違反チェック・AI分析](#10-違反チェックai分析)
11. [レポート](#11-レポート)
12. [エクスポート（CSV / Excel / PDF）](#12-エクスポートcsv--excel--pdf)
13. [AI機能（自然文入力）](#13-ai機能自然文入力)
14. [API リファレンス](#14-api-リファレンス)
15. [トラブルシューティング](#15-トラブルシューティング)

---

## 1. システム概要

本システムは、クリニックの職員シフト表を LLM（Claude API）との対話と数理最適化（OR-Tools CP-SAT）で作成するWebアプリケーションです。

### 主な特長

- **自然文入力**: 「毎週火曜のデイケアは2名以上」のような日本語から、ルールやイベントを自動構造化
- **複数案自動生成**: 3パターン（均等配分 / ハード制約厳守 / ソフト制約最大化）を同時に比較
- **リアルタイム違反チェック**: 必須制約・推奨制約の違反をリアルタイムで検出し、AI が改善案を提示
- **多形式エクスポート**: CSV / Excel / PDF 出力

### 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | Next.js 14 (App Router) + React 18 + Tailwind CSS |
| バックエンド | FastAPI + SQLAlchemy 2 (async) + Pydantic 2 |
| データベース | PostgreSQL 16 (本番) / SQLite (開発) |
| ソルバー | Google OR-Tools CP-SAT |
| AI/LLM | Anthropic Claude API (Tool Use) |
| エクスポート | openpyxl (Excel) + reportlab (PDF) |
| キャッシュ | Redis 7 |

---

## 2. 環境構築・セットアップ

### 2.1 前提条件

- Docker / Docker Compose（推奨）
- または Node.js 18+ / Python 3.12+

### 2.2 Docker Compose での起動（推奨）

```bash
# リポジトリをクローン
git clone <repository-url>
cd clinic-schedule

# 起動
docker-compose up -d
```

サービスが起動すると以下にアクセスできます:

| サービス | URL |
|---------|-----|
| フロントエンド | http://localhost:3000 |
| バックエンド API | http://localhost:8000 |
| Swagger UI (API ドキュメント) | http://localhost:8000/docs |
| PostgreSQL | localhost:5432 |
| Redis | localhost:6379 |

### 2.3 手動セットアップ（Docker 不使用）

#### バックエンド

```bash
cd backend

# 仮想環境の作成
python -m venv venv
source venv/bin/activate   # Windows: venv\Scripts\activate

# 依存パッケージのインストール
pip install -r requirements.txt

# 環境変数の設定
cp .env.example .env  # 必要に応じて .env を編集
```

`.env` ファイルに設定可能な値:

| 変数名 | 説明 | デフォルト値 |
|--------|------|-------------|
| `DATABASE_URL` | DB接続文字列 | `sqlite+aiosqlite:///./clinic_schedule.db` |
| `REDIS_URL` | Redis接続文字列 | `redis://localhost:6379/0` |
| `CORS_ORIGINS` | CORS許可オリジン | `["http://localhost:3000"]` |
| `ANTHROPIC_API_KEY` | Claude API キー | `""` (空の場合 AI 機能無効) |
| `DEBUG` | デバッグモード | `True` |

```bash
# バックエンド起動
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

#### フロントエンド

```bash
cd frontend

# 依存パッケージのインストール
npm install

# 開発サーバー起動
npm run dev
```

### 2.4 初期データ

起動時に以下のマスターデータが自動投入されます:

- **時間帯マスタ**: AM / 昼 / PM / 15時 / 16時 / 17時 / 18- の7区分
- **カラー凡例**: 休み / 早出 / 遅出 / 訪問 等
- **スキルマスタ**: CP (臨床心理) / PSW (精神保健福祉) / NS (看護) / DRIVER 等
- **業務コードサンプル**: デイケア / ナイトケア / 訪問看護 等

### 2.5 AI 機能を有効にする

自然文入力・違反AI説明を利用するには、`ANTHROPIC_API_KEY` を設定してください:

```bash
# .env ファイルに追記
ANTHROPIC_API_KEY=sk-ant-api03-xxxxxxxxxxxx
```

APIキーが未設定の場合もアプリ自体は動作しますが、AI関連のボタンが503エラーを返します。

---

## 3. 画面構成と基本操作

### 3.1 ナビゲーション

画面上部のナビゲーションバーから各機能にアクセスできます:

| タブ | パス | 説明 |
|------|------|------|
| シフト表 | `/` | メイン画面。月次シフトグリッドの表示・編集 |
| 職員管理 | `/staffs` | 職員のCRUD、スキル割当 |
| 業務コード管理 | `/task-types` | 業務種別の定義 |
| イベント管理 | `/events` | 個別予定・案件の登録 |
| ルール管理 | `/rules` | スケジューリング制約の定義 |
| レポート | `/reports` | 違反・案比較レポート |

---

## 4. シフト表（メイン画面）

### 4.1 画面構成

メイン画面は上から順に以下で構成されます:

1. **ツールバー**: 月の選択、ステータス操作、案生成、エクスポート
2. **自然文入力バー**: イベントの自然文登録
3. **シフトグリッド**: 日付 × 時間帯 × 職員 のマトリクス
4. **違反チェックパネル**: ルール違反の表示とAI分析
5. **カラー凡例**: ステータス色の説明

### 4.2 スケジュールの作成

1. ツールバーの「+ 新規」ボタンをクリック
2. 年月（例: `2025-04`）を入力
3. 空のシフト表が生成される

### 4.3 スケジュールのステータス

| ステータス | 説明 | 操作 |
|-----------|------|------|
| `draft` (下書き) | 編集可能。案生成・手動編集可 | →「確認中へ」ボタンで reviewing へ |
| `reviewing` (確認中) | 編集可能。最終確認フェーズ | →「確定」で confirmed / →「下書きに戻す」で draft |
| `confirmed` (確定済み) | 編集不可。確定後の変更は不可 | — |

### 4.4 セルの編集

- グリッド上のセルをクリックすると編集モードになります
- 業務コード（デイケア、訪問等）を選択して割当を設定
- セルを右クリックまたはロックアイコンで **ロック** すると、ソルバー実行時に上書きされません

### 4.5 時間帯の構成

| コード | 表示名 | 時間範囲 | 所要時間 |
|--------|--------|---------|---------|
| `am` | AM | 9:00-12:00 | 180分 |
| `lunch` | 昼 | 12:00-13:00 | 60分 |
| `pm` | PM | 13:00-15:00 | 120分 |
| `15` | 15時 | 15:00-16:00 | 60分 |
| `16` | 16時 | 16:00-17:00 | 60分 |
| `17` | 17時 | 17:00-18:00 | 60分 |
| `18plus` | 18- | 18:00-20:00 | 120分 |

---

## 5. 職員管理

パス: `/staffs`

### 5.1 職員の登録

「+ 新規作成」ボタンから以下の情報を入力:

| フィールド | 説明 | 例 |
|-----------|------|-----|
| 名前 | 職員名 | 山田太郎 |
| 雇用形態 | 常勤/非常勤 | fulltime / parttime |
| 職種 | 職種区分 | psw / cp / nurse / ot |
| 車運転可 | 訪問時に車を使用可能か | ON/OFF |
| 自転車可 | 訪問時に自転車を使用可能か | ON/OFF |
| 有効 | 現在アクティブか | ON/OFF |

### 5.2 スキルの割当

各職員にスキル（資格・能力）を割当可能です:

| スキルコード | 説明 |
|-------------|------|
| CP | 臨床心理士 |
| PSW | 精神保健福祉士 |
| NS / NURSE | 看護師 |
| OT | 作業療法士 |
| DRIVER | 運転可能 |

スキルレベル: `qualified`(有資格) / `preferred`(推奨) / `learning`(研修中)

---

## 6. 業務コード管理

パス: `/task-types`

業務コードは、シフトセルに割り当てるタスク種別を定義します。

### 6.1 主なフィールド

| フィールド | 説明 | 例 |
|-----------|------|-----|
| コード | 一意の業務コード | `dc` |
| 表示名 | 画面表示名 | デイケア |
| 場所種別 | in_clinic / outing / visit | `in_clinic` |
| デフォルト時間帯 | 通常使用する時間帯 | `["am", "pm"]` |
| 必須スキル | 担当に必要なスキル | `["PSW"]` |
| タグ | 分類用タグ | `["定期", "院内"]` |

### 6.2 場所種別

| 値 | 説明 |
|----|------|
| `in_clinic` | 院内業務 |
| `outing` | 外出プログラム |
| `visit` | 訪問（車または自転車が必要な場合あり） |

---

## 7. イベント管理

パス: `/events`

イベントは、特定の患者やプログラムに紐づく個別の予定です。

### 7.1 イベントの登録方法

**方法A: フォームから登録**

1. 「+ 新規作成」ボタンをクリック
2. 業務コード、対象者名、所要時間、時間制約等を入力

**方法B: 自然文から登録（AI）**

1. シフト表画面の自然文入力バーに日本語を入力
2. 例: `山田さんの心理検査2回目を今月の木曜午後に`
3. 送信 → AI が解析 → プレビュー表示 → 確定

### 7.2 時間制約の種別

| 種別 | 説明 | 例 |
|------|------|-----|
| `fixed` | 日時が確定 | 5/15 13:00 |
| `range` | 範囲指定 | 火曜・木曜の午後 |
| `candidates` | 候補日時リスト | 5/13 AM または 5/15 PM |

### 7.3 イベントステータス

| ステータス | 説明 |
|-----------|------|
| `unassigned` | 未割当。ソルバーが配置を試みる |
| `assigned` | ソルバーまたは手動で割当済み |
| `cancelled` | キャンセル |

---

## 8. ルール管理

パス: `/rules`

### 8.1 ルールの種類

| template_type | 説明 | 例 |
|--------------|------|-----|
| `headcount` | 人員配置 | デイケアは常時2名以上 |
| `availability` | 勤務制限 | 山田は水曜休み |
| `skill_req` | スキル要件 | 心理検査はCP必須 |
| `resource_req` | リソース要件 | 訪問看護は車1台必要 |
| `preference` | 優先配置 | 佐藤をデイケア木曜に優先 |
| `recurring` | 定期予定 | 毎週月〜金のAM/PMにデイケア |
| `specific_date` | 特定日 | 5/15はスタッフ3名体制 |

### 8.2 制約の強度

| 種類 | 説明 | ソルバーへの影響 |
|------|------|----------------|
| `hard` (必須) | 絶対に違反不可 | 制約を満たさない解は棄却 |
| `soft` (推奨) | 違反にペナルティ | 重み×違反数を目的関数に加算 |

重み (weight): 1〜1000。値が大きいほどソルバーが優先して遵守。

### 8.3 自然文からルールを作成（AI入力）

1. ルール管理ページの「AI入力」バーに自然文を入力
2. 例: `毎週火曜と木曜の午後にデイケアは2名以上必要`
3. 送信 → AI が template_type / hard_or_soft / body を推定
4. 解析結果をプレビュー確認 → 「確定」で登録

### 8.4 ルール検索

ルール一覧上部の検索バーにキーワードを入力して検索できます。
自然文・種別・タグ・body 内容を横断的にスコアリング検索します。

---

## 9. 自動案生成（ソルバー）

### 9.1 単一案生成

1. シフト表画面でスケジュールを選択（下書きまたは確認中）
2. ツールバーの「案生成」ボタンをクリック
3. OR-Tools CP-SAT ソルバーが最適解を探索（デフォルト30秒）
4. 結果が自動的にグリッドに反映

**注意**: ロック済みセルは上書きされません。

### 9.2 複数案比較（A/B/C）

1. ツールバーの「A/B/C比較」ボタンをクリック
2. 3つのプリセットで同時にソルバーを実行:

| 案 | プリセット | 特徴 |
|----|----------|------|
| A | 均等配分 | 職員間の負担バランスを最重視 |
| B | ハード制約厳守 | 必須制約の充足を最優先 |
| C | ソフト制約最大化 | 推奨ルール・イベント配置を最大化 |

3. モーダルで3案を比較:
   - ステータス（最適解 / 実行可能解 / 解なし）
   - 割当数・イベント配置数
   - 目的関数値・計算時間
4. 「この案を適用」ボタンで選択した案をグリッドに反映

### 9.3 ソルバーが考慮する制約

- ルール（hard/soft）
- イベント（時間制約、必須スキル、リソース要件）
- 既存のロック済み割当
- 職員の勤務可能日・スキル

---

## 10. 違反チェック・AI分析

### 10.1 違反チェック

シフト表画面下部の「検証実行」ボタンで、現在のスケジュールのルール違反を検出します。

**違反の種類:**

| 種類 | 表示 | 説明 |
|------|------|------|
| ハード違反 | 赤背景 | 必須制約の違反。解決が必須 |
| ソフト違反 | 黄背景 | 推奨制約の違反。改善が望ましい |

各違反には以下の情報が表示されます:
- 違反内容の説明
- 影響する日付・時間帯
- 重み（ソフト違反の場合）
- 改善提案

### 10.2 AI 説明

違反が検出されている状態で「AI説明」ボタンをクリックすると、Claude API が違反一覧を分析して以下を日本語で回答します:

1. 全体の状況サマリー
2. 最も重要な問題とその影響
3. 具体的な改善提案（優先順）

---

## 11. レポート

パス: `/reports`

レポートページでは、選択したスケジュールの違反状況を俯瞰できます。

### 11.1 サマリーカード

- **必須違反**: ハード制約の違反件数
- **推奨違反**: ソフト制約の違反件数
- **合計ペナルティ**: ソフト違反の重み合計

### 11.2 違反詳細リスト

ハード違反・ソフト違反をそれぞれ一覧表示。各違反の影響範囲と改善提案を確認できます。

### 11.3 AI 分析

「AI分析」ボタンで Claude API による包括的な分析結果を取得できます。

### 11.4 案の比較

レポートページからも A/B/C 案を生成・比較・適用できます。テーブル形式で各案のメトリクスを並べて確認できます。

---

## 12. エクスポート（CSV / Excel / PDF）

シフト表画面のツールバー右端にある出力ボタンからダウンロードできます。

### 12.1 CSV

- テキスト形式。他システムへのインポートに適している
- ファイル名: `schedule_YYYY-MM.csv`

### 12.2 Excel (.xlsx)

- スタイル付き Excel ファイル
- ヘッダー行にフィルター用スタイル適用
- 週末行を黄色ハイライト
- ペイン固定（F4セルで固定 → ヘッダーと日付列が常時表示）
- ファイル名: `schedule_YYYY-MM.xlsx`

### 12.3 PDF

- A4 横向き。印刷に最適化
- テーブルグリッド形式
- 週末行ハイライト
- フッターに出力日・職員数・ステータスを表示
- 職員が10名を超える場合は列を制限
- ファイル名: `schedule_YYYY-MM.pdf`

---

## 13. AI機能（自然文入力）

### 13.1 必要な設定

環境変数 `ANTHROPIC_API_KEY` に有効な Claude API キーを設定してください。

### 13.2 イベントの自然文入力

**場所**: シフト表画面 → 自然文入力バー

**入力例:**

| 入力文 | 解析結果 |
|--------|---------|
| `山田さんの心理検査2回目を今月の木曜午後に` | type: psych_test, subject: 山田, 木曜PM, skills: CP |
| `来週月曜の午前にデイケア` | type: dc, 来週月曜AM |
| `佐藤さんの訪問看護、車で3時間` | type: visit_nurse, subject: 佐藤, 3h, resource: car |

### 13.3 ルールの自然文入力

**場所**: ルール管理ページ → AI入力バー

**入力例:**

| 入力文 | 解析結果 |
|--------|---------|
| `毎週火曜と木曜の午後にデイケアは2名以上必要` | recurring, hard, weekdays:[1,3], pm, min_staff:2 |
| `山田は水曜と金曜は午後勤務不可` | availability, hard, blocked_weekdays:[2,4], blocked_blocks:["pm"] |
| `訪問看護には車が必要` | resource_req, hard, required_resources:["car"] |

### 13.4 違反の AI 説明

**場所**: シフト表画面 → 違反パネルの「AI説明」ボタン、またはレポートページの「AI分析」ボタン

違反一覧を Claude API に送信し、自然言語で要約・分析・改善提案を受け取ります。

---

## 14. API リファレンス

ベースパス: `/api/v1`

インタラクティブな API ドキュメントは http://localhost:8000/docs でアクセスできます。

### 14.1 主要エンドポイント一覧

#### 職員

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/staffs` | 職員一覧 |
| POST | `/staffs` | 職員作成 |
| PUT | `/staffs/{id}` | 職員更新 |
| DELETE | `/staffs/{id}` | 職員削除 |
| GET | `/staffs/{id}/skills` | スキル取得 |
| PUT | `/staffs/{id}/skills` | スキル一括更新 |
| GET | `/staffs/skills` | スキルマスタ一覧 |

#### 業務コード

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/task-types` | 業務コード一覧 |
| POST | `/task-types` | 業務コード作成 |
| PUT | `/task-types/{code}` | 業務コード更新 |
| DELETE | `/task-types/{code}` | 業務コード削除 |

#### イベント

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/events` | イベント一覧 |
| POST | `/events` | イベント作成 |
| POST | `/events/from-text` | 自然文→イベント解析 |
| GET | `/events/{id}` | イベント詳細 |
| PUT | `/events/{id}` | イベント更新 |
| DELETE | `/events/{id}` | イベント削除 |

#### ルール

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/rules` | ルール一覧 |
| POST | `/rules` | ルール作成 |
| POST | `/rules/from-text` | 自然文→ルール解析 |
| GET | `/rules/search?q=` | ルール検索 |
| GET | `/rules/{id}` | ルール詳細 |
| PUT | `/rules/{id}` | ルール更新 |
| PATCH | `/rules/{id}/toggle` | 有効/無効切替 |
| DELETE | `/rules/{id}` | ルール削除 |

#### スケジュール

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/schedules` | スケジュール一覧 |
| POST | `/schedules` | スケジュール作成 |
| PATCH | `/schedules/{id}/status` | ステータス更新 |
| GET | `/schedules/{id}/grid` | グリッドデータ取得 |

#### 割当

| メソッド | パス | 説明 |
|---------|------|------|
| PUT | `/schedules/{id}/assignments` | 割当の作成/更新 |
| DELETE | `/schedules/{id}/assignments/{aid}` | 割当の削除 |
| PATCH | `/schedules/{id}/assignments/{aid}/lock` | ロック切替 |

#### ソルバー

| メソッド | パス | 説明 |
|---------|------|------|
| POST | `/schedules/{id}/solve` | 単一案生成 |
| POST | `/schedules/{id}/solve/solutions` | A/B/C 3案生成 |
| POST | `/schedules/{id}/solve/solutions/{preset}/apply` | 案の適用 |

#### 違反チェック

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/schedules/{id}/violations` | 違反一覧 |
| POST | `/schedules/{id}/violations/check` | 違反チェック実行 |
| POST | `/schedules/{id}/violations/explain` | AI による違反説明 |

#### エクスポート

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/schedules/{id}/export/csv` | CSV ダウンロード |
| GET | `/schedules/{id}/export/excel` | Excel ダウンロード |
| GET | `/schedules/{id}/export/pdf` | PDF ダウンロード |

#### その他

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/time-blocks` | 時間帯マスタ |
| GET | `/color-legend` | カラー凡例 |
| PUT | `/schedules/{id}/day-programs` | デイリープログラム更新 |
| GET | `/health` | ヘルスチェック |

---

## 15. トラブルシューティング

### AI 機能が動作しない

- `ANTHROPIC_API_KEY` が `.env` に設定されていることを確認
- バックエンドを再起動: `docker-compose restart backend`
- ログ確認: `docker-compose logs backend`

### ソルバーが「解なし」を返す

- ハード制約が矛盾していないか確認（ルール管理画面で一覧チェック）
- ロック済みの割当がハード制約と衝突していないか確認
- ソフト制約に切り替えて再試行
- A/B/C 比較で案Cを試す（ソフト制約最大化）

### Excel / PDF エクスポートが遅い

- 職員数が多い場合、PDF は10名までに列を制限します
- Excel は全職員を出力しますが、月末までの全行を生成するため少し時間がかかります

### データベースの初期化

```bash
# SQLite の場合（開発環境）
cd backend
rm clinic_schedule.db
uvicorn app.main:app  # 再起動で自動再生成

# Docker の場合
docker-compose down -v  # ボリュームも削除
docker-compose up -d
```

### ポート競合

デフォルトポートが使用中の場合は `docker-compose.yml` で変更:

```yaml
# backend
ports:
  - "8001:8000"  # 左側を変更

# frontend
ports:
  - "3001:3000"  # 左側を変更
```

フロントエンドのプロキシ先も `frontend/next.config.js` で合わせて変更してください。
