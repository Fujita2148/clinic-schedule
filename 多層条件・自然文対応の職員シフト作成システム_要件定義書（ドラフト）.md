# 多層条件・自然文対応の職員シフト作成システム 要件定義書（ドラフト）

## 0. 前提と目的
本システムは、外来クリニックにおける複数業務（外来、デイケア、ナイトケア、訪問看護/訪問診療補助、心理検査、年金申請サポート、個別面接、会議、記録/事務等）を対象に、**1時間粒度**で職員配置（シフト）を作成・調整する。

特徴は以下。
- 条件・暗黙知が多く、かつ月ごとに変動する環境で、**自然文で条件や予定を入力**しつつ、
  - 叩き台（案）生成
  - 違反・未充足条件の可視化
  - 修正ループ
  - 条件知識の蓄積
  を可能にする。
- すべての条件を満たす解が存在しない場合でも、**何が満たせていないか（違反/未充足）を理由付きで提示**し、意思決定を支援する。
- 現行のExcel運用（職員×日行列、1か月1シート）を尊重し、移行負担を小さくする。

## 1. 対象範囲（スコープ）
### 1.1 対象職員
- 医師：常勤1、非常勤2
- 事務：常勤1、非常勤1
- PSW：常勤1
- PSW+CP：常勤1
- 看護師：常勤1、非常勤3

備考：
- 医師・事務の外来/訪問診療は概ね曜日固定で調整は小。
- 主に調整が必要なのは PSW/CP/看護師（デイケア、ナイトケア、訪問看護、面接、検査、年金等）。

### 1.2 対象業務（イベント）
- デイケア（プログラム含む、外部講師・外出あり）
- ナイトケア
- 訪問看護（移動手段制約あり）
- 個別面接（担当患者）
- 心理検査（担当患者、回数など案件情報あり）
- 年金申請サポート（案件情報あり）
- 記録/事務
- 夜間会議参加（地域関係者会議など）
- 事務の休暇に伴う非常勤事務の補完（軽微）

### 1.3 施設・資源制約
- 車：1台
- 自転車：2台
- 部屋：診察室2（医師優先）、職員スペース転用1
  - 実運用上、スタッフ面接/検査等で利用できる同時枠は **実質2枠**
- 外出プログラム時のスタッフ同行人数など、イベント固有要件あり

### 1.4 時間粒度
- 基本：1時間単位
- 将来拡張：内部スロットを15分単位等に拡張できる設計を許容

## 2. ゴールと成功条件
### 2.1 ゴール
- シフト作成者が、
  1) 月間の叩き台を作り、
  2) 違反/未充足条件を把握し、
  3) 代替案を検討しながら修正できる
  ことを、現行Excelより速く・ミス少なく実現する。

### 2.2 成功条件（KPI例）
- シフト作成に要する所要時間の短縮
- ルール違反（車/部屋/人数/必須条件など）の見落としゼロ化
- 欠勤・急用発生時の再調整時間の短縮
- 条件（暗黙知）の文書化・検索性の向上

## 3. 基本コンセプト（アーキテクチャ方針）
### 3.1 「自然文」と「式化（構造化）」の二重管理
- 条件・予定は自然文を保存し、同時にシステムが解ける形式へ「式化」する。
- 式化は完全自動にせず、**テンプレート（型）**に落とし込む方式を基本とする。
- 自然文・式化は常に対応づけられ、閲覧・編集できる。

### 3.2 役割分担
- LLM：自然文→テンプレ候補提案、説明文生成、ルール不足の質問提示
- ソルバ（制約充足/最適化）：ハード制約を守り、ソフト制約は点数化して案生成
- UI：即時検証、違反の見える化、修正ループの高速化

## 4. データモデル（概念）
### 4.1 スタッフ
- 氏名/ID
- 雇用形態（常勤/非常勤）
- 職種/資格（複数可：PSW、CP、看護師等）
- スキル/属性（運転可否、自転車可否、訪問可否、プログラム適性など）
- 予定（固定勤務、休暇希望、会議予定等）
- 制約（連勤上限、夜間後の配慮、勤務可能時間帯など）

### 4.2 業務コード辞書（拡張可能）
- code（短い識別子）
- 表示名
- デフォルト所要時間
- 必須/優先の資格・スキル
- 必須資源（車/自転車/部屋）
- 必要人数（単独/複数）
- タグ（デイケア/訪問/面接/検査/年金/会議など）

### 4.3 イベント（予定・案件）
- 種類（業務コード）
- 対象（患者名または匿名ID、プログラム名など）
- **location_type**（院内 / 外出 / 訪問）
- 所要時間（1時間単位。将来拡張可）
- 時間条件：
  - 固定（日時確定）
  - 範囲（例：今月木曜午後のどこか）
  - 複数候補（候補集合）
- 担当条件（必須/優先/可）
- 資源条件（部屋、車、自転車）
- 優先度（必須/最優先/可能なら/ベター）
- 期限（例：月末まで）
- メモ

### 4.4 ルール（制約）
- 自然文（原文）
- テンプレ種別（後述）
- 適用範囲（毎月、特定日、曜日、週番号、第3水曜AM等）
- 優先度（必須/最優先/可能なら/ベター）
- 重み（ソフト制約点数）
- 例外規定
- 状態（有効/無効）
- 作成者/更新者/更新日時

## 5. ルールテンプレート（最小セット）
以下の型を用意し、自然文入力から候補を提案する。
1. 定期予定（繰り返し）
   - 例：ヨガは第3水曜午前
2. 特定日予定
   - 例：5月6日は外出プログラム
3. 人数要件
   - 例：外出プログラムは職員3人必要
4. 資格/スキル要件
   - 例：心理検査はCPが担当（必須/優先）
5. 資源要件（車/自転車/部屋）
   - 例：遠方訪問は車必須／同時に使える面接枠は2
6. 優先配置（望ましい配置）
   - 例：〇〇プログラムはAが入ると安定（ソフト）
7. 休暇希望・勤務可能時間
   - 例：○○さんは金曜午後不可

## 6. 機能要件
### 6.1 シフト表（職員×時間）
- 月間表示（1時間グリッド）
- セルに業務コード割当
- 入力時に即時検証（違反はハイライト、理由表示）
- フィルタ（職種、資格、運転可、担当案件など）
- 印刷/PDF/CSV出力（現行Excel互換を重視）

### 6.2 イベント（予定・案件）管理
- イベント作成：
  - フォーム入力
  - 自然文入力（例：「山田さんの心理検査2回目を今月木曜午後どこかに」）
- イベントの候補時間指定（範囲/候補集合）
- イベントの割当（自動/手動）
- イベントの状態（未割当/割当済/保留/完了）

### 6.3 ルール辞書（自然文⇄式化）
- ルール一覧（検索・タグ・優先度フィルタ）
- ルールの閲覧（自然文と式化を並列表示）
- ルールの編集（テンプレ/適用範囲/優先度/重み/例外）
- ルールのON/OFF
- ルール入力支援（テンプレ候補提案）

### 6.4 案生成（叩き台）
- 初期案生成：
  - 固定枠（曜日固定等）をロック
  - 難しい枠（訪問・運転・外出人数・部屋など）から埋める
- 複数案（A/B/C）の提示（ソフト制約の重み違い等）

### 6.5 検証・レポート（未充足の可視化）
- ハード違反一覧（絶対不可）
- ソフト違反一覧（どれを犠牲にしたか）
- 影響分析：変更時に影響範囲を提示
- 代替案提示：
  - 人員入替
  - プログラム日程変更案
  - 訪問の移動手段変更案など

### 6.6 インポート/エクスポート
- 既存Excelからの取り込み（段階的移行）
- CSV出力（給与集計等への連携余地）

### 6.7 権限・監査（必要に応じて）
- 編集者（シフト作成者）と閲覧者（スタッフ）
- 変更履歴（誰がいつ何を変えたか）

## 7. 非機能要件
- 使いやすさ：Excelから乗り換え可能な操作感（ショートカット・コピー・連続入力）
- 信頼性：自動割当の結果は必ず理由付きで検証可能
- 保守性：業務コード・ルールテンプレの追加が容易
- 可搬性：ローカル運用/院内LANのみ等の要件が出た場合に対応余地
- セキュリティ：患者名を扱う場合は匿名ID化やアクセス制御を考慮

## 8. 画面案（最小4画面）
1) 月間シフト表（職員×時間）
2) イベント一覧（未割当/割当済）
3) ルール辞書（自然文⇄式化）
4) 違反/未充足レポート

## 9. 運用フロー（想定）
1) 月次イベント生成（定期プログラム＋特定日）
2) 休暇希望・固定枠入力
3) 叩き台生成
4) 違反/未充足確認
5) 修正（人の判断：プログラム日変更・担当調整）
6) 確定版出力（PDF/CSV）
7) 変更発生時は差分修正→影響表示→再出力

## 10. 未決事項（設計で詰める項目）
- 1時間粒度で足りない業務（移動・外出・会議）への扱い
- 心理検査の標準所要時間と分割可否
- 面接/検査の部屋予約の詳細（医師優先の例外、優先度ルール）
- 訪問看護の分類（自転車圏/車必須などのレベル）
- 公平性指標（夜間・土日・負荷配分）の扱い
- スタッフへの公開範囲（患者名を含む案件の表示方針）

## 11. 内部設計（LLMの呼び方）

## 11-A. スキーマ設計方針（固定コア＋拡張レイヤ）
### 11-A.1 固定コア（ソルバが理解する最小スキーマ）
- **イベント固定コア**：
  - id
  - type_code
  - subject_name
  - location_type（院内 / 外出 / 訪問）
  - duration
  - time_constraint
  - required_skills / preferred_skills
  - required_resources
  - priority
  - deadline
  - notes

- **ルール固定コア**：
  - id
  - natural_text
  - template_type
  - scope
  - hard_or_soft
  - weight
  - body
  - exceptions

→ 固定コアは JSON Schema で厳格に検証し、最適化・違反検証の対象とする。

### 11-A.2 拡張レイヤ（動的・人間中心）
- attributes（自由記述のキー・バリュー辞書）
  - 例：検査回数、担当医、訪問先特性、外部講師有無、移動注意事項 等
- links（外部参照）
  - カルテID、文書ID、URL 等
- provisional_constraints（仮ルール）
  - テンプレ未定義の自然文条件を一時保存

→ 拡張レイヤは検索・説明には使うが、**直接ソルバには渡さない**。

### 11-A.3 テンプレ昇格ルール（運用）
- provisional_constraints が
  - 一定回数（例：3回/月以上）出現
  - または管理者が明示的に指定
 した場合、テンプレ化候補として提示する。
- テンプレ化後は、既存の仮ルールを一括変換可能とする。

## 11. 内部設計（LLMの呼び方）
### 11.1 LLMの役割（原則）
- **決定（割当・最適化）をLLMに任せない**。LLMは「自然文→構造化」「説明」「不足情報の特定」に限定する。
- 構造化データ（イベント/ルール）へ変換した後は、ソルバ（制約充足/最適化）で解く。

### 11.2 LLM呼び出しユースケース
1) **自然文→イベント作成（案件）**
- 入力例：「山田さんの心理検査2回目を今月の木曜午後のどこかに入れる」
- 出力：イベントJSON（種類/対象/所要/候補時間/期限/担当条件/資源）

2) **自然文→ルール（制約）追加**
- 入力例：「外出プログラムの時は職員3人つくこと」
- 出力：ルールJSON（テンプレ種別/適用範囲/優先度/重み/対象イベント/人数等）

3) **検証結果（違反一覧）→説明文生成**
- ソルバが返した違反/未充足を、
  - どの条件が衝突しているか
  - 何を緩めれば解が出そうか
  を自然文で要約し、代替案の方向性（提案）を出す。

4) **ルール辞書の整理（暗黙知の昇格）**
- 似たルールの統合候補提示、タグ付け、重み提案、例外抽出。

### 11.3 構造化の方式（テンプレ＋関数呼び出し）
- LLMには「テンプレ候補を選ぶ」タスクを与え、**関数呼び出し（function/tool calling）でJSONを生成**させる。
- 変換後のJSONはバリデーション（スキーマ＋業務辞書）し、曖昧さが残る場合はLLMに確認質問を生成させる。

（例）イベントJSONの最小スキーマ案：
- type_code
- subject (patient_id or program_name)
- duration_hours
- time_constraint { fixed | range | candidates }
- required_skills / preferred_skills
- required_resources
- priority_level
- deadline
- notes

（例）ルールJSONの最小スキーマ案：
- template_type
- applies_to (event_type/program_tag/date_rule)
- time_window
- hard_or_soft
- weight
- constraint_body (count/skill/resource/precedence 等)
- exceptions

### 11.4 ルール検索（RAG）
- ルール辞書を全文検索＋埋め込み検索で参照し、
  - 「今月木曜午後」などの入力時に関連ルール（検査はCP、部屋は2枠等）を自動提示する。
- ただし最終的にソルバに渡すのは“式化済みルール”のみ。

### 11.5 安全・情報統制（患者情報）
- **本システムでは患者・スタッフともに実名で扱うことを前提**とする。
- ただし、LLMへの送信データは用途別に制御し、
  - 構造化（イベント/ルール抽出）に不要な場合は、患者名を伏せたIDに自動変換して送信するオプションを持つ。
- 実名をLLMに送信する場合は、
  - 利用目的（自然文理解・説明生成）を限定
  - 送信内容をログとして保存（監査用）
  - モデル/プロバイダを明示した上で運用
  とする。
- UI上は、権限に応じて
  - 全実名表示
  - 患者名マスキング（例：担当者以外はイニシャル）
  の切替を将来拡張として許容する。

## 12. 内部設計（ソルバの使用方法）
### 12.1 ソルバ選定
- 第一候補：**OR-Tools CP-SAT**（制約充足＋ソフト制約の最小化に強い）
- 代替：貪欲＋局所改善（MVP段階で簡易実装）

### 12.2 モデル化（基本）
- 時間：1時間スロット（将来は内部15分も可能）
- 変数：
  - x[staff, time, task] ∈ {0,1}（その時間にその職員がその業務に従事）
  - または task_at[staff, time]（カテゴリ値）
- イベント割当：
  - y[event, start_time, staff] ∈ {0,1}（候補開始時刻にその職員で割り当て）
  - 所要時間分の連続スロットを占有

### 12.3 ハード制約（例）
- 同一職員は同一時間に1タスクのみ
- 部屋：スタッフ面接/検査の同時枠 ≤ 2
- 車：同時使用 ≤ 1、自転車同時使用 ≤ 2
- 必須人数：外出プログラム時スタッフ数 ≥ 3
- 資格：心理検査はCP必須（hard扱いにする場合）

### 12.4 ソフト制約（例）
- プログラムの曜日・週（第3水曜AMなど）を満たす（満たせない場合はペナルティ）
- 特定スタッフの優先配置（満たせない場合は小〜中ペナルティ）
- 休暇希望・負荷配分（夜間会議翌日の軽減等）

### 12.5 目的関数（例）
- Σ(ソフト制約違反ペナルティ) を最小化
- 優先度に応じて重みを変える：
  - 最優先：大
  - 可能なら：中
  - ベター：小

### 12.6 “解なし”の扱い（未充足の特定）
- 設計方針：原則、ハード制約により解なしにならないよう、
  - 可能なものはソフト制約に落とす
  - 「必須だが現実には破れる可能性がある」ものは、
    破った事実を明示するために“ハードにしない”選択も可能
- それでも解なしの場合：
  - CP-SATの**assumptions（仮定リテラル）**を用い、
    不充足の原因となる制約集合（近い形の説明）を取得する運用を検討する。

### 12.7 インクリメンタル運用
- 月次の大枠を解いた後、欠勤等の変更は
  - 既存解を初期解として再探索
  - 変更範囲を最小化する目的（差分ペナルティ）を追加
  して“崩れにくい再調整”を実現する。

---

## 付録A：自然文入力例
- 「5月6日のデイケアは外出プログラム」
- 「ヨガのプログラムは第3水曜の午前中」
- 「外出プログラムの時は職員3人つくこと」
- 「山田さんの心理検査2回目を今月の木曜午後のどこかに入れる」

## 付録B：優先度（質的差）の扱い
- 必須（ハード制約）：違反不可
- 最優先：原則守る（高いソフト重み）
- 可能なら：中程度のソフト重み
- 満たせればベター：低いソフト重み

※「常識的知識」「物理的要件」はタグとして保持し、デフォルト重みや説明の文体に反映する。

